{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Inscrição - {{ evento.nome }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --space-1:6px; --space-2:10px; --space-3:14px; --space-4:18px; --space-5:22px; }
    *{box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;
      line-height:1.5; max-width:480px; margin:20px auto; padding:15px; background:#fff; color:#333; position:relative;
    }
    body::before{
      content:""; position:fixed; inset:0;
      {% if politica.imagem_2 %}background-image:url("{{ politica.imagem_2.url }}");{% endif %}
      background-size:cover; background-position:center; filter:blur(5px); opacity:.2; z-index:-1;
    }
    header{text-align:center;margin-bottom:var(--space-5);position:relative}
    header img{display:block;max-width:100%;height:auto;border-radius:8px;margin:0 auto var(--space-3);box-shadow:0 4px 6px rgba(0,0,0,.1)}
    header h1{font-size:1.8rem;margin:0 0 var(--space-1);color:#222}
    .info-periodos p{font-size:.95rem;margin:2px 0;color:#555;line-height:1.35}

    #id_nome, #id_endereco, #id_bairro { text-transform: capitalize; }

    form{
      background:#fff; padding:20px 18px; border-radius:12px; box-shadow:0 2px 5px rgba(0,0,0,.1);
      display:flex; flex-direction:column; gap:var(--space-3); position:relative;
    }
    .field{display:flex;flex-direction:column;row-gap:6px}
    .field label{font-weight:600;color:#444}
    .field input[type="text"], .field input[type="email"]{
      padding:10px 12px;font-size:1rem;border:1.8px solid #ccc;border-radius:12px;
      transition:border-color .25s ease, box-shadow .25s ease;width:100%;background:#fff;
    }
    .field input:focus{border-color:#007bff;outline:none;box-shadow:0 0 0 3px rgba(0,123,255,.15)}
    .errorlist{margin:0;padding-left:18px;color:#b00020;font-size:.9rem}
    .hint{font-size:.85rem;color:#666;margin-top:-4px}
    #id_cpf[aria-invalid="true"]{border-color:#b00020}
    .cpf-error{font-size:.9rem;color:#b00020;margin:-4px 0 0}

    .extra-fields{display:grid;grid-template-columns:1fr;gap:var(--space-3);margin-top:var(--space-2)}
    .extra-fields[hidden]{display:none!important}

    /* cônjuge – feedback */
    #id_cpf_conjuge[aria-invalid="true"]{ border-color:#b00020 }
    #cpf_conjuge_feedback{ font-size:.85rem; margin-top:2px; }

    button{
      background:#007bff;color:#fff;padding:12px;border:none;border-radius:10px;
      font-size:1.05rem;font-weight:700;cursor:pointer;transition:background-color .25s ease;margin-top:2px;
    }
    button:hover,button:focus{background:#0056b3;outline:none}
    button[disabled]{opacity:.6;cursor:not-allowed}

    .politica-link{text-align:center;margin-top:var(--space-4);font-weight:600}
    .politica-link a{color:#007bff;text-decoration:none}
    .politica-link a:hover{text-decoration:underline}

    #whatsapp-flutuante{
      position: fixed; bottom: 20px; right: 20px; width: 64px; height: 64px;
      padding: 0; border: 0; background: transparent; border-radius: 50%;
      box-shadow: 0 4px 10px rgba(0,0,0,.25); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      z-index: 1100; transition: transform .15s ease, box-shadow .15s ease;
    }
    #whatsapp-flutuante img{
      width: 100%; height: 100%; object-fit: cover; border-radius: 50%; display: block;
    }
    #whatsapp-flutuante:hover,#whatsapp-flutuante:focus{
      transform: scale(1.06); box-shadow: 0 6px 16px rgba(0,0,0,.35); outline: none;
    }

    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;
      overflow:auto;background-color:rgba(0,0,0,.5);justify-content:center;align-items:center;padding:20px}
    .modal-content{background:#fff;border-radius:10px;max-width:400px;width:100%;box-shadow:0 5px 15px rgba(0,0,0,.3);
      position:relative;font-size:.95rem;color:#222;max-height:70vh;overflow-y:auto;padding:20px;text-align:center}
    .modal-body{text-align:left}
    .close-modal{color:#aaa;position:absolute;right:15px;top:10px;font-size:28px;font-weight:bold;cursor:pointer}
    .close-modal:hover,.close-modal:focus{color:#000}
    .btn-whatsapp{
      background:#25D366;color:#fff !important;border:0;border-radius:10px;padding:12px 18px;font-weight:700;font-size:1rem;
      text-decoration:none;display:inline-flex;align-items:center;gap:8px;box-shadow:0 3px 8px rgba(0,0,0,.2);
      transition:transform .15s ease, box-shadow .15s ease, background .15s ease;
    }
    .btn-whatsapp:hover,.btn-whatsapp:focus{background:#1ebe5b;text-decoration:none;transform:translateY(-1px);box-shadow:0 6px 14px rgba(0,0,0,.25)}
    .btn-whatsapp:focus-visible{outline:3px solid rgba(37,211,102,.35);outline-offset:2px}

    @media (max-width:480px){
      body{margin:10px;padding:10px;padding-bottom:90px}
      form{padding:16px;border-radius:12px}
    }
  </style>
</head>
<body>
  <header>
    {% if evento.banner %}
      <img src="{{ evento.banner.url }}" alt="Banner do Evento {{ evento.nome }}">
    {% endif %}
    <h1>{{ evento.nome }}</h1>
    <div class="info-periodos">
      <p><strong>Período de Inscrição:</strong> {{ evento.inicio_inscricoes|date:"d/m/Y" }} – {{ evento.fim_inscricoes|date:"d/m/Y" }}</p>
      <p><strong>Período do Evento:</strong> {{ evento.data_inicio|date:"d/m/Y" }} – {{ evento.data_fim|date:"d/m/Y" }}</p>
    </div>
  </header>

  {% if form %}
  <form method="post" novalidate id="form-inscricao">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <div class="field">
      <label for="id_cpf">CPF</label>
      {{ form.cpf.errors }}
      {{ form.cpf }}
      <small class="hint">Digite seu CPF (11 dígitos). Ex.: 123.456.789-09</small>
      <div id="cpf_error" class="cpf-error" aria-live="polite"></div>
    </div>

    <div id="extra-fields" class="extra-fields" hidden aria-hidden="true">
      <div class="field">
        <label for="id_nome">Nome</label>
        {{ form.nome.errors }}
        {{ form.nome }}
      </div>

      <div class="field">
        <label for="id_telefone">Telefone</label>
        {{ form.telefone.errors }}
        {{ form.telefone }}
      </div>

      <div class="field">
        <label for="id_email">Email</label>
        {{ form.email.errors }}
        {{ form.email }}
        <small class="hint">Por aqui você receberá informações sobre o evento.</small>
      </div>

      {% if evento.tipo == 'casais' %}
      <div class="field" id="box-cpf-conjuge">
        <label for="id_cpf_conjuge">CPF do cônjuge (opcional)</label>
        <input type="text" id="id_cpf_conjuge" name="cpf_conjuge" placeholder="000.000.000-00" />
        <small class="hint">Se o(a) cônjuge ainda não se inscreveu, deixe em branco.</small>
        <div id="cpf_conjuge_feedback" aria-live="polite"></div>
      </div>
      {% endif %}
    </div>

    <button type="submit" id="btn-next" disabled>Próxima Etapa</button>
  </form>
  {% endif %}

  {% if endereco_form %}
  <form method="post" novalidate style="margin-top: var(--space-5);">
    {% csrf_token %}
    {{ endereco_form.non_field_errors }}

    <div class="field">
      <label for="id_CEP">CEP</label>
      {{ endereco_form.CEP.errors }}
      {{ endereco_form.CEP }}
    </div>
    <div class="field">
      <label for="id_endereco">Endereço</label>
      {{ endereco_form.endereco.errors }}
      {{ endereco_form.endereco }}
    </div>
    <div class="field">
      <label for="id_numero">Número</label>
      {{ endereco_form.numero.errors }}
      {{ endereco_form.numero }}
    </div>
    <div class="field">
      <label for="id_bairro">Bairro</label>
      {{ endereco_form.bairro.errors }}
      {{ endereco_form.bairro }}
    </div>
    <div class="field">
      <label for="id_cidade">Cidade</label>
      {{ endereco_form.cidade.errors }}
      {{ endereco_form.cidade }}
    </div>
    <div class="field">
      <label for="id_estado">Estado</label>
      {{ endereco_form.estado.errors }}
      {{ endereco_form.estado }}
    </div>

    <button type="submit">Próxima Etapa</button>
  </form>
  {% endif %}

  <p class="politica-link">
    <a href="#" data-bs-toggle="modal" data-bs-target="#modalPolitica">Política de Privacidade</a>
  </p>
  <p style="text-align:center;font-size:.75rem;color:rgba(0,0,0,.25);margin-top:4px;">
    eismeaqui.app - Desenvolvido por Alexandre Martins Vieira 2025 ©
  </p>

  <div class="modal fade" id="modalPolitica" tabindex="-1" aria-labelledby="modalPoliticaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalPoliticaLabel">Política de Privacidade</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">{{ politica.texto|linebreaks }}</div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button></div>
      </div>
    </div>
  </div>

  <button id="whatsapp-flutuante" type="button" aria-label="Ajuda">
    {% if politica.imagem_ajuda %}
      <img src="{{ politica.imagem_ajuda.url }}" alt="Ajuda" width="64" height="64" loading="lazy">
    {% else %}
      <img src="{% static 'img/ajuda/porquinho.png' %}" alt="Ajuda" width="64" height="64" loading="lazy">
    {% endif %}
  </button>

  <div id="modal-whatsapp" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="modal-whatsapp-title">
    <div class="modal-content">
      <span class="close-modal" id="fechar-whatsapp" aria-label="Fechar">&times;</span>
      <h2 id="modal-whatsapp-title">Fale conosco pelo WhatsApp</h2>
      <p>Estamos prontos para ajudar você!</p>
      <a href="https://wa.me/5511999999999" target="_blank" rel="noopener noreferrer" class="btn-whatsapp">Abrir WhatsApp</a>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/inputmask@5.0.9/dist/inputmask.min.js"></script>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const verInscricaoBase = "{% url 'inscricoes:ver_inscricao' 0 %}".replace('/0/', '/');

    const form1         = document.getElementById("form-inscricao");
    const cpfInput      = document.getElementById("id_cpf");
    const nomeInput     = document.getElementById("id_nome");
    const emailInput    = document.getElementById("id_email");
    const telefoneInput = document.getElementById("id_telefone");
    const cepInput      = document.getElementById("id_CEP");
    const enderecoInput = document.getElementById("id_endereco");
    const bairroInput   = document.getElementById("id_bairro");
    const cidadeInput   = document.getElementById("id_cidade");
    const estadoInput   = document.getElementById("id_estado");
    const btnNext       = document.getElementById("btn-next");
    const cpfErrBox     = document.getElementById("cpf_error");
    const extraBox      = document.getElementById("extra-fields");

    // NOVO: cônjuge
    const cpfConjInput    = document.getElementById("id_cpf_conjuge");
    const cpfConjFeedback = document.getElementById("cpf_conjuge_feedback");

    // máscaras
    try{ if(cpfInput){ Inputmask("999.999.999-99").mask(cpfInput); cpfInput.placeholder='000.000.000-00'; } }catch(e){}
    try{ if(telefoneInput){ Inputmask({mask:["(99) 9999-9999","(99) 99999-9999"], keepStatic:true}).mask(telefoneInput); } }catch(e){}
    try{ if(cepInput){ Inputmask("99.999-999").mask(cepInput); } }catch(e){}
    try{ if(cpfConjInput){ Inputmask("999.999.999-99").mask(cpfConjInput); } }catch(e){}

    // utils
    const onlyDigits = s => (s||"").replace(/\D/g,"");
    function cpfIsValid(raw){
      const c = onlyDigits(raw);
      if(c.length!==11) return false;
      if(/^(\d)\1{10}$/.test(c)) return false;
      let sum=0; for(let i=0;i<9;i++) sum += parseInt(c[i],10)*(10-i);
      let d1=11-(sum%11); if(d1>9) d1=0; if(d1!==parseInt(c[9],10)) return false;
      sum=0; for(let i=0;i<10;i++) sum += parseInt(c[i],10)*(11-i);
      let d2=11-(sum%11); if(d2>9) d2=0; return d2===parseInt(c[10],10);
    }
    function toggleExtraFields(show){
      if(!extraBox) return;
      if(show){ extraBox.hidden=false; extraBox.setAttribute('aria-hidden','false'); }
      else{ extraBox.hidden=true; extraBox.setAttribute('aria-hidden','true'); }
    }
    function applyCpfValidation(){
      if(!cpfInput) return false;
      const raw=cpfInput.value||"";
      const digits=onlyDigits(raw);
      const valid=(digits.length===11 && cpfIsValid(raw));
      cpfInput.setAttribute("aria-invalid", (!valid && digits.length>0) ? "true" : "false");
      cpfErrBox.textContent = (!valid && digits.length>0) ? "CPF inválido. Verifique os dígitos." : "";
      if(btnNext) btnNext.disabled = !valid || extraBox.hidden;
      return valid;
    }

    // title-case helpers
    const toTitle = (s) => (s || '')
      .replace(/\s+/g, ' ')
      .split(' ')
      .map(p => p ? p.charAt(0).toUpperCase() + p.slice(1).toLowerCase() : '')
      .join(' ');
    function normalizeOnInput(el, formatter){
      el.addEventListener('input', () => {
        const before = el.value;
        const pos = el.selectionStart;
        const after = formatter(before);
        if(after !== before){
          el.value = after;
          try{ el.setSelectionRange(pos,pos); }catch(_){}
        }
      });
      el.addEventListener('blur', () => el.value = formatter(el.value || ''));
    }
    if(nomeInput)     normalizeOnInput(nomeInput, toTitle);
    if(enderecoInput) normalizeOnInput(enderecoInput, toTitle);
    if(bairroInput)   normalizeOnInput(bairroInput, toTitle);

    // mostra extras ao validar CPF principal
    if(cpfInput){
      const onCpfChange = () => {
        const ok = applyCpfValidation();
        toggleExtraFields(ok);
        if(ok && nomeInput && !nomeInput.value){ nomeInput.focus(); }
      };
      cpfInput.addEventListener("input", onCpfChange);
      cpfInput.addEventListener("paste", () => setTimeout(onCpfChange, 0));
    }

    // validação leve do CPF do cônjuge (não bloqueia)
    function validateCpfConjuge(){
      if(!cpfConjInput) return;
      const raw = cpfConjInput.value || "";
      const d   = onlyDigits(raw);
      if(d.length===0){
        cpfConjInput.removeAttribute("aria-invalid");
        if(cpfConjFeedback){
          cpfConjFeedback.textContent = "";
          cpfConjFeedback.style.color = "";
        }
        return;
      }
      const ok = cpfIsValid(raw);
      cpfConjInput.setAttribute("aria-invalid", ok ? "false" : "true");
      if(cpfConjFeedback){
        cpfConjFeedback.textContent = ok ? "" : "CPF do cônjuge inválido (opcional).";
        cpfConjFeedback.style.color = ok ? "" : "#b00020";
      }
    }
    cpfConjInput?.addEventListener("input", validateCpfConjuge);

    // busca o nome (e possível inscrição) do cônjuge no blur/change
    async function lookupConjuge(){
      if(!cpfConjInput) return;
      const raw = cpfConjInput.value || "";
      const d   = onlyDigits(raw);
      if(d.length!==11 || !cpfIsValid(raw)){
        if(cpfConjFeedback){ cpfConjFeedback.textContent=""; cpfConjFeedback.style.color=""; }
        return;
      }
      try{
        const url = "{% url 'inscricoes:ajax_buscar_conjuge' %}" + `?cpf=${d}&evento_id={{ evento.id }}`;
        const r = await fetch(url);
        if(!r.ok) return;
        const j = await r.json();
        if(!cpfConjFeedback) return;

        if(j.ok && j.nome){
          cpfConjFeedback.innerHTML = `Cônjuge: <strong>${j.nome}</strong>`;
          cpfConjFeedback.style.color = "#0f5132"; // verde
          if(j.inscricao_id){
            cpfConjFeedback.innerHTML += "<br>Inscrição do cônjuge encontrada — o vínculo será aplicado.";
          } else {
            cpfConjFeedback.innerHTML += "<br>Nenhuma inscrição encontrada ainda — tudo bem, o vínculo será aplicado quando ele(a) se inscrever.";
          }
        }else if(j.ok && !j.nome){
          cpfConjFeedback.textContent = "Não encontramos cadastro para este CPF — sem problemas, o vínculo será aplicado quando o cadastro/inscrição for criado(a).";
          cpfConjFeedback.style.color = "#8a6d3b"; // amarelo/aviso
        }
      }catch(_){}
    }
    cpfConjInput?.addEventListener("blur", lookupConjuge);
    cpfConjInput?.addEventListener("change", lookupConjuge);

    // busca participante pelo CPF principal (preenche nome/email/telefone se existir)
    if(cpfInput){
      cpfInput.addEventListener("blur", async () => {
        if(!applyCpfValidation()) return;
        const cpf = onlyDigits(cpfInput.value);
        if(cpf.length!==11) return;

        try{
          const url = `/ajax/buscar-participante/?cpf=${cpf}&evento_id={{ evento.id }}`;
          const res = await fetch(url);
          if(!res.ok) return;
          const data = await res.json();

          if (data && data.progresso && data.progresso.next_url){
            window.location.href = data.progresso.next_url;
            return;
          }
          if (data && data.ja_inscrito && data.inscricao_id){
            window.location.href = verInscricaoBase + data.inscricao_id + '/';
            return;
          }
          if (data && (data.status === 'enviada' || data.status === 'concluida')){
            const destino = data.view_url || (verInscricaoBase + (data.inscricao_id || '') + '/');
            if (destino) { window.location.href = destino; return; }
          }
          if (data){
            if (data.nome && nomeInput)           nomeInput.value = toTitle(data.nome);
            if (data.email && emailInput)         emailInput.value = data.email;
            if (data.telefone && telefoneInput)   telefoneInput.value = data.telefone;
          }
        }catch(err){
          console.error("Erro ao buscar participante:", err);
        }
      });
    }

    // submit guard
    if(form1){
      form1.addEventListener("submit",(e)=>{
        const ok = applyCpfValidation();
        if(!ok || extraBox.hidden){
          e.preventDefault();
          if(cpfInput) cpfInput.focus();
        }
        // cpf do cônjuge é opcional
      });
    }

    // ViaCEP
    const limpaEndereco=()=>{
      if(enderecoInput) enderecoInput.value="";
      if(bairroInput)   bairroInput.value="";
      if(cidadeInput)   cidadeInput.value="";
      if(estadoInput)   estadoInput.value="";
    }
    if(cepInput){
      cepInput.addEventListener("blur", async () => {
        const cep = onlyDigits(cepInput.value);
        if(!/^[0-9]{8}$/.test(cep)){
          limpaEndereco();
          if(cep) alert("Formato de CEP inválido.");
          return;
        }
        [enderecoInput,bairroInput,cidadeInput,estadoInput].forEach(i=>i&&(i.value="..."));
        try{
          const resCep = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
          const d = await resCep.json();
          if(d.erro) throw new Error("CEP não encontrado.");
          if(enderecoInput) enderecoInput.value = toTitle(d.logradouro || "");
          if(bairroInput)   bairroInput.value   = toTitle(d.bairro || "");
          if(cidadeInput)   cidadeInput.value   = d.localidade || "";
          if(estadoInput)   estadoInput.value   = d.uf || ""
        }catch(e){
          console.error("Erro ao buscar CEP:", e);
          alert(e.message || "Erro ao buscar CEP.");
          limpaEndereco();
        }
      });
    }

    // Modal ajuda
    const modal = document.getElementById("modal-whatsapp");
    const btn   = document.getElementById("whatsapp-flutuante");
    const close = document.getElementById("fechar-whatsapp");
    btn?.addEventListener("click", ()=> modal.style.display="flex");
    close?.addEventListener("click", ()=> modal.style.display="none");
    window.addEventListener("click", e => e.target===modal && (modal.style.display="none"));
    window.addEventListener("keydown", e => e.key==="Escape" && (modal.style.display="none"));

    // estado inicial
    if(cpfInput){
      const startValid = applyCpfValidation();
      toggleExtraFields(startValid);
      if(startValid && btnNext) btnNext.disabled = false;
    }
  });
  </script>
</body>
</html>
