{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Inscrição Casal - {{ evento.nome }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Datepicker + FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 900px; margin: 20px auto; padding: 15px; background-color: #fff; color: #333; position: relative; }
    {% if politica and politica.imagem_2 %}
    body::before { content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: url("{{ politica.imagem_2.url }}"); background-size: cover; background-position: center; filter: blur(5px); opacity: 0.2; z-index: -1; }
    {% endif %}
    header { text-align: center; margin-bottom: 20px; }
    header img { max-width: 100%; border-radius: 8px; margin-bottom: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    header h1 { font-size: 1.8rem; margin-bottom: 6px; color: #222; }

    form { background: white; padding: 20px 18px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; gap: 15px; }
    fieldset { border: 1px solid #ddd; padding: 20px; border-radius: 8px; margin-bottom: 25px; }
    legend { font-size: 1.3rem; font-weight: 700; color: #0d6efd; }
    label { font-weight: 600; margin-top: 10px; display: block; }

    input[type="text"], input[type="email"], input[type="number"], input[type="date"], select, textarea {
      padding: 10px; font-size: 1rem; border: 1.8px solid #ccc; border-radius: 6px; transition: border-color 0.3s ease; width: 100%;
    }
    input:focus, select:focus, textarea:focus { border-color: #007bff; outline: none; box-shadow: 0 0 6px rgba(0, 123, 255, 0.3); }

    button { background: #007bff; color: white; padding: 14px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: background-color 0.3s ease; }
    button:hover { background: #0056b3; }

    .helptext, .text-danger { font-size: .85rem; }
    .campo-filho { margin-top: 15px; padding: 10px; border: 1px dashed #ccc; border-radius: 6px; }

    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 2000; }
    .modal.show { display: flex; }
    .modal-content { background: #fff; border-radius: 10px; padding: 20px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; text-align: center; position: relative; }
    .close { position: absolute; right: 15px; top: 10px; font-size: 28px; cursor: pointer; }

    #whatsapp-flutuante { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 2100; transition: transform .15s ease, box-shadow .15s ease; box-shadow: 0 4px 10px rgba(0,0,0,.25); }
    #whatsapp-flutuante img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
    #whatsapp-flutuante:hover { transform: scale(1.06); box-shadow: 0 6px 16px rgba(0,0,0,.35); }

    .btn-whatsapp { background-color: #25D366; color: white; border: none; border-radius: 8px; padding: 14px 24px; font-size: 18px; font-weight: 600; text-decoration: none; display: inline-block; transition: background-color 0.3s ease; }
    .btn-whatsapp:hover { background-color: #128C4A; }

    .politica-link { text-align: center; margin-top: 20px; font-weight: 600; }
    .politica-link a { color: #007bff; text-decoration: none; }
    .politica-link a:hover { text-decoration: underline; }

    footer { text-align: center; font-size: 0.75rem; color: rgba(0,0,0,0.25); margin-top: 10px; }

    /* preview da foto do casal */
    #preview-foto-casal{
      width: 96px; height: 96px; object-fit: cover; border-radius: 12px;
      border: 1px solid #e5e7eb; background: #f8fafc; display: none;
    }
  </style>
</head>
<body>
  <header>
    {% if evento.banner %}
      <img src="{{ evento.banner.url }}" alt="Banner {{ evento.nome }}">
    {% endif %}
    <h1>{{ evento.nome }}</h1>
    <p><strong>Data:</strong> {{ evento.data_inicio|date:"d/m/Y" }} - {{ evento.data_fim|date:"d/m/Y" }}</p>
  </header>

  <!-- data-etapa para o script saber se é cônjuge 1 ou 2 -->
  <form method="post" enctype="multipart/form-data" novalidate data-etapa="{{ etapa }}">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="alert alert-danger">{{ form.non_field_errors }}</div>
    {% endif %}
    {% if form_insc.non_field_errors %}
      <div class="alert alert-danger">{{ form_insc.non_field_errors }}</div>
    {% endif %}

    <fieldset>
      <legend>Cônjuge {{ etapa }}</legend>

      <div class="row">
        <div class="col-md-6">
          <label for="{{ form.nome.id_for_label }}">Nome completo</label>
          {{ form.nome }} <div class="text-danger">{{ form.nome.errors }}</div>
        </div>
        <div class="col-md-6">
          <label for="{{ form.cpf.id_for_label }}">CPF</label>
          {{ form.cpf }} <div class="text-danger">{{ form.cpf.errors }}</div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <label for="{{ form.email.id_for_label }}">E-mail</label>
          {{ form.email }} <div class="text-danger">{{ form.email.errors }}</div>
        </div>
        <div class="col-md-6">
          <label for="{{ form.telefone.id_for_label }}">Telefone</label>
          {{ form.telefone }} <div class="text-danger">{{ form.telefone.errors }}</div>
        </div>
      </div>

      {% if etapa == 1 %}
      <!-- ====================== ENDEREÇO (CÔNJUGE 1) ====================== -->
      <fieldset id="fieldset-endereco" class="mt-1">
        <legend>Endereço</legend>
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label" for="id_cep">CEP</label>
            <input type="text" id="id_cep" name="cep" class="form-control" placeholder="00000-000" required>
          </div>
          <div class="col-md-8">
            <label class="form-label" for="id_endereco">Logradouro</label>
            <input type="text" id="id_endereco" name="endereco" class="form-control" placeholder="Rua, Av., Travessa..." required>
          </div>
          <div class="col-md-4">
            <label class="form-label" for="id_numero">Número</label>
            <input type="text" id="id_numero" name="numero" class="form-control" placeholder="Nº" required>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="id_bairro">Bairro</label>
            <input type="text" id="id_bairro" name="bairro" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="id_cidade">Cidade</label>
            <input type="text" id="id_cidade" name="cidade" class="form-control" required>
          </div>
          <div class="col-md-3">
            <label class="form-label" for="id_estado">Estado (UF)</label>
            <input type="text" id="id_estado" name="estado" class="form-control" maxlength="2" placeholder="SP" required>
          </div>
        </div>
        <div class="alert alert-info mt-3" role="alert">
          Esse endereço será utilizado para o cônjuge 2 automaticamente.
        </div>
      </fieldset>
      {% endif %}

      <!-- Campo fixo: Qual tema do acampamento que participou? -->
      <div class="mb-3">
        <label for="id_tema_acampamento">Qual tema do acampamento que participou?</label>
        <input
          type="text"
          id="id_tema_acampamento"
          name="tema_acampamento"
          class="form-control"
          placeholder="Ex.: Sênior 2024 - 'Em Cristo somos um'"
          value="{{ request.POST.tema_acampamento|default_if_none:'' }}"
          required
        >
      </div>

      {% if etapa == 1 %}
      <div class="mb-3">
        <label for="id_qtd_filhos">Quantidade de filhos</label>
        <select id="id_qtd_filhos" name="qtd_filhos" class="form-select">
          <option value="0">Nenhum</option>
          <option value="1">1 filho</option>
          <option value="2">2 filhos</option>
          <option value="3">3 filhos</option>
          <option value="4">4 filhos</option>
        </select>
      </div>
      <div id="filhos_campos"></div>

      <!-- Compartilhados (view espera esses names) -->
      <fieldset class="mt-3">
        <legend>Contato de emergência</legend>
        <label>Nome</label>
        <input type="text" name="contato_emergencia_nome" class="form-control">
        <label>Telefone</label>
        <input type="text" name="contato_emergencia_telefone" class="form-control">
      </fieldset>

      <fieldset class="mt-3">
        <legend>Contato adicional</legend>
        <label>Nome</label>
        <input type="text" name="responsavel_2_nome" class="form-control">
        <label>Telefone</label>
        <input type="text" name="responsavel_2_telefone" class="form-control">
      </fieldset>
      {% endif %}

      <!-- ===== Demais campos do form de casais (exceto foto_casal) ===== -->
      {% for field in form_insc %}
        {% if field.name != "foto_casal" %}
          <div class="mb-3">
            {{ field.label_tag }}
            {{ field }}
            {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
            {% for err in field.errors %}<div class="text-danger">{{ err }}</div>{% endfor %}
          </div>
        {% endif %}
      {% endfor %}

      {% if etapa == 2 %}
      <!-- ============== FOTO DO CASAL — SOMENTE NA ETAPA 2 (no fim) ============== -->
      <div id="foto-casal-final" class="mb-4">
        <label for="{{ form_insc.foto_casal.id_for_label }}">Foto do casal</label>
        <div class="d-flex align-items-center gap-3">
          <img id="preview-foto-casal" alt="Pré-visualização">
          {{ form_insc.foto_casal }}
        </div>
        <div class="form-text">A foto será salva nas duas inscrições e nos dois participantes.</div>
        <div class="text-danger">{{ form_insc.foto_casal.errors }}</div>
      </div>
      {% endif %}

    </fieldset>

    <button type="submit">
      {% if etapa == 1 %}Continuar (Cônjuge 2){% else %}Finalizar inscrição{% endif %}
    </button>
  </form>

  <p class="politica-link">
    <a href="#" onclick="openModal('modalPolitica')">Política de Privacidade</a>
  </p>

  <footer>eismeaqui.app - Desenvolvido por Alexandre Martins Vieira 2025 ©</footer>

  <div id="modalPolitica" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('modalPolitica')">&times;</span>
      <h3>Política de Privacidade</h3>
      {% if politica %}{{ politica.texto|linebreaks }}{% endif %}
    </div>
  </div>

  <div id="whatsapp-flutuante" onclick="openModal('modalWhatsApp')">
    {% if politica and politica.imagem_ajuda %}
      <img src="{{ politica.imagem_ajuda.url }}" alt="Ajuda">
    {% else %}
      <img src="{% static 'img/ajuda/porquinho.png' %}" alt="Ajuda">
    {% endif %}
  </div>

  <div id="modalWhatsApp" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('modalWhatsApp')">&times;</span>
      <h3>Fale conosco pelo WhatsApp</h3>
      <p>Estamos prontos para ajudar você!</p>
      <a href="https://wa.me/5511999999999" target="_blank" class="btn-whatsapp">Abrir WhatsApp</a>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/locales/bootstrap-datepicker.pt-BR.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/inputmask@5.0.9/dist/inputmask.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- =================== SCRIPT BASE =================== -->
<script>
  $(function() {
    // Evita duplo envio
    $("form[data-etapa]").on("submit", function(){
      const $btn = $(this).find("button[type='submit']").last();
      $btn.prop("disabled", true).text("Enviando...");
    });

    // ================= Máscaras principais =================
    if (window.Inputmask) {
      if ($("#id_cpf").length)       Inputmask("999.999.999-99").mask("#id_cpf");
      if ($("#id_telefone").length)  Inputmask({ mask: ["(99) 9999-9999", "(99) 99999-9999"], keepStatic: true }).mask("#id_telefone");
      if ($("#id_data_nascimento").length)
        Inputmask("99/99/9999", { placeholder: "DD/MM/AAAA", clearMaskOnLostFocus: false }).mask("#id_data_nascimento");
    }

    // ================= Datepicker =================
    if ($.fn.datepicker) {
      $('.date').datepicker({
        format: 'dd/mm/yyyy',
        language: 'pt-BR',
        autoclose: true,
        todayHighlight: true
      });
    }

    // ================= Modais =================
    window.openModal = function(id) { $('#' + id).addClass('show'); };
    window.closeModal = function(id) { $('#' + id).removeClass('show'); };
    $(window).on('click', function(e) { if ($(e.target).hasClass('modal')) closeModal(e.target.id); });
    $(window).on('keydown', function(e) {
      if (e.key === 'Escape') $('.modal.show').each(function(){ closeModal(this.id); });
    });

    // ================= Condicionais de saúde =================
    function toggleCondicionais() {
      const is = (sel, val) => $(sel).val && $(sel).val() === val;

      if ($("#id_problema_saude").length)
        $("#id_qual_problema_saude").closest("p,div,.mb-3").toggle(is("#id_problema_saude","sim"));
      if ($("#id_medicamento_controlado").length)
        $("#id_qual_medicamento_controlado").closest("p,div,.mb-3").toggle(is("#id_medicamento_controlado","sim"));
      if ($("#id_mobilidade_reduzida").length)
        $("#id_qual_mobilidade_reduzida").closest("p,div,.mb-3").toggle(is("#id_mobilidade_reduzida","sim"));
      if ($("#id_alergia_alimento").length)
        $("#id_qual_alergia_alimento").closest("p,div,.mb-3").toggle(is("#id_alergia_alimento","sim"));
      if ($("#id_alergia_medicamento").length)
        $("#id_qual_alergia_medicamento").closest("p,div,.mb-3").toggle(is("#id_alergia_medicamento","sim"));
    }
    $("#id_problema_saude, #id_medicamento_controlado, #id_mobilidade_reduzida, #id_alergia_alimento, #id_alergia_medicamento")
      .on("change", toggleCondicionais);
    toggleCondicionais();

    // ================= Campos de filhos dinâmicos =================
    $("#id_qtd_filhos").on("change", function() {
      const qtd = parseInt($(this).val(), 10) || 0;
      const container = $("#filhos_campos");
      container.empty();

      for (let i = 1; i <= qtd; i++) {
        container.append(`
          <div class="campo-filho">
            <h6>Filho ${i}</h6>
            <label>Nome</label>
            <input type="text" name="filho_${i}_nome" class="form-control">
            <label>Idade</label>
            <input type="number" name="filho_${i}_idade" class="form-control">
            <label>Telefone</label>
            <input type="text" name="filho_${i}_telefone" class="form-control telefone-filho">
          </div>
        `);
      }

      if (window.Inputmask) {
        Inputmask({ mask: ["(99) 9999-9999", "(99) 99999-9999"], keepStatic: true })
          .mask($("#filhos_campos .telefone-filho"));
      }
    });

    // ====== FOTO DO CASAL (somente etapa 2) — sem duplicar o campo ======
    (function(){
      const etapa = parseInt($("form[data-etapa]").attr("data-etapa") || "1", 10);
      const $file = $("input[name='foto_casal']");
      const $preview = $("#preview-foto-casal");

      if (!$file.length) return;         // nada a fazer na etapa 1
      $file.attr("accept","image/*");
      if (etapa === 2) $file.prop("required", true);

      $file.on("change", function(){
        const f = this.files && this.files[0];
        if (!f) { $preview.hide(); return; }
        if (!f.type.startsWith("image/")) { this.value=""; $preview.hide(); return; }
        const reader = new FileReader();
        reader.onload = e => { $preview.attr("src", e.target.result).show(); };
        reader.readAsDataURL(f);
      });
    })();

  });
</script>

<!-- =================== CEP → auto-preencher (ViaCEP com debounce) =================== -->
<script>
  $(function () {
    function maskTelefone($els) {
      if (window.Inputmask) {
        Inputmask({ mask: ["(99) 9999-9999", "(99) 99999-9999"], keepStatic: true }).mask($els);
      }
    }
    maskTelefone($("input[name='contato_emergencia_telefone'], input[name='responsavel_2_telefone']"));

    if (window.Inputmask && $("#id_cep").length) Inputmask("99999-999").mask("#id_cep");

    function limpaEndereco() {
      if ($("#id_endereco").length) $("#id_endereco").val("");
      if ($("#id_bairro").length)   $("#id_bairro").val("");
      if ($("#id_cidade").length)   $("#id_cidade").val("");
      if ($("#id_estado").length)   $("#id_estado").val("");
    }

    async function preencherEnderecoPorCEP(cep) {
      const cepNum = (cep || "").replace(/\D/g, "");
      if (cepNum.length !== 8) { limpaEndereco(); return; }
      try {
        const resp = await fetch(`https://viacep.com.br/ws/${cepNum}/json/`);
        if (!resp.ok) throw new Error("Falha ao consultar CEP");
        const data = await resp.json();
        if (data.erro) { limpaEndereco(); return; }

        if ($("#id_endereco").length) $("#id_endereco").val(data.logradouro || "");
        if ($("#id_bairro").length)   $("#id_bairro").val(data.bairro || "");
        if ($("#id_cidade").length)   $("#id_cidade").val(data.localidade || "");
        if ($("#id_estado").length)   $("#id_estado").val((data.uf || "").toUpperCase());
      } catch (e) {
        limpaEndereco();
      }
    }

    let cepTimer = null;
    function debounceCEP(handler) {
      clearTimeout(cepTimer);
      cepTimer = setTimeout(handler, 300);
    }

    $("#id_cep")
      .on("blur", function () { preencherEnderecoPorCEP(this.value); })
      .on("keyup", function () {
        const val = this.value;
        debounceCEP(() => {
          const digits = (val || "").replace(/\D/g, "");
          if (digits.length === 8) preencherEnderecoPorCEP(val);
        });
      });

    const cepInicial = $("#id_cep").val && $("#id_cep").val();
    if (cepInicial && cepInicial.replace(/\D/g, "").length === 8) {
      preencherEnderecoPorCEP(cepInicial);
    }
  });
</script>

<!-- =================== Organização do bloco de saúde =================== -->
<script>
  $(function () {
    const $form = $("form[data-etapa]");
    if (!$form.length) return;

    if (!$("#fieldset-saude").length) {
      $form.append(`
        <fieldset id="fieldset-saude" class="mt-3">
          <legend>Dados de Saúde</legend>
          <div class="alert alert-warning" role="alert">
            <strong>Atenção:</strong> preencha todas as informações de saúde com <u>exatidão</u>.
          </div>
          <div id="bloco-saude" class="row g-3"></div>
        </fieldset>
      `);
    }

    const $destSaude = $("#bloco-saude");
    const healthIds = [
      "id_problema_saude","id_qual_problema_saude",
      "id_medicamento_controlado","id_qual_medicamento_controlado","id_protocolo_administracao",
      "id_mobilidade_reduzida","id_qual_mobilidade_reduzida",
      "id_alergia_alimento","id_qual_alergia_alimento",
      "id_alergia_medicamento","id_qual_alergia_medicamento",
      "id_diabetes","id_pressao_alta","id_tipo_sanguineo"
    ];

    function moveToSaude(id){
      const $el = $("#"+id);
      if (!$el.length || $el.closest("#bloco-saude").length) return;
      let $block = $el.closest(".col-md-6, .mb-3, .form-group, p, .form-check, div").first();
      if (!$block.length) { $block = $("<div class='col-md-6 mb-2'></div>").append($el); }
      if (!$block.hasClass("col-md-6")) $block.addClass("col-md-6");
      $block.appendTo($destSaude);
    }
    healthIds.forEach(moveToSaude);

    function toggleCondicionaisSaude() {
      const showIf = (condSel, value, targetSel) => {
        if (!$(condSel).length || !$(targetSel).length) return;
        $(targetSel).closest(".col-md-6, p,div,.mb-3,.form-group")
          .toggle($(condSel).val() === value);
      };
      showIf("#id_problema_saude","sim","#id_qual_problema_saude");
      showIf("#id_medicamento_controlado","sim","#id_qual_medicamento_controlado");
      showIf("#id_mobilidade_reduzida","sim","#id_qual_mobilidade_reduzida");
      showIf("#id_alergia_alimento","sim","#id_qual_alergia_alimento");
      showIf("#id_alergia_medicamento","sim","#id_qual_alergia_medicamento");
    }

    $("#id_problema_saude, #id_medicamento_controlado, #id_mobilidade_reduzida, #id_alergia_alimento, #id_alergia_medicamento")
      .off("change._saude_final").on("change._saude_final", toggleCondicionaisSaude);
    toggleCondicionaisSaude();

    const $submit = $form.find("button[type='submit']").last();
    $form.append($submit);
  });
</script>

</body>
</html>
